<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="JoonHo Lee (jlee296@ua.edu)">
<meta name="author" content="Mehdi Rajeb">
<meta name="dcterms.date" content="2023-02-25">

<title>Chapter 4. Random-coefficient models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="04_Random_Coefficeint_models_files/libs/clipboard/clipboard.min.js"></script>
<script src="04_Random_Coefficeint_models_files/libs/quarto-html/quarto.js"></script>
<script src="04_Random_Coefficeint_models_files/libs/quarto-html/popper.min.js"></script>
<script src="04_Random_Coefficeint_models_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="04_Random_Coefficeint_models_files/libs/quarto-html/anchor.min.js"></script>
<link href="04_Random_Coefficeint_models_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="04_Random_Coefficeint_models_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="04_Random_Coefficeint_models_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="04_Random_Coefficeint_models_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="04_Random_Coefficeint_models_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Chapter 4. Random-coefficient models</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>JoonHo Lee (jlee296@ua.edu) </p>
             <p>Mehdi Rajeb </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 25, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction4.1" class="level1">
<h1>Introduction(4.1)</h1>
<p>In this chapter, we include random coefficients or random slops in addition to random intercepts, thus also allowing the effects of covariates to vary between clusters. Such model involving both random intercepts and random slopes are often call random-coefficient models.</p>
<section id="how-effective-are-different-schools4.2" class="level2">
<h2 class="anchored" data-anchor-id="how-effective-are-different-schools4.2">How effective are different schools?(4.2)</h2>
<p>Here we analyze a dataset on inner-london schools. At age 16, students took their Graduate Certificate of Secondary Education(GCSE) exams in a number of subjects. A score was derived from the individual exam results. Such scores often form the basis for school comparisons, for instance, to allow parents to choose the best school for their child. However, schools can differ considerably in their intake achievement levels. It may be argued that what should be compared is the “value added”; that is, the difference in mean GCSE score between schools after controlling for the students’ achievement before entering the school. once such measure of prior achievement is the London Reading Test(LRT) take by these students at age 11.</p>
<p>The dataset gcse.dta has the following variables:</p>
<ul>
<li><p><code>school</code>: school identifier</p></li>
<li><p><code>student</code>: student identifier</p></li>
<li><p><code>gcse</code>: Graduate Certificate of Secondary Education (GCSE) score (z score, multiplied by 10)</p></li>
<li><p><code>lrt</code>: London Reading Test(LRT) score (z score, multiplied by 10)</p></li>
<li><p><code>girl</code> : dummy variable for student being a girl (1: girl; 0: boys)</p></li>
<li><p><code>schgend</code>: type of school (1: mixed gender; 2: boys only; 3: girls only)</p></li>
</ul>
<p>We have following objectives to investigate from the data set.</p>
<ul>
<li><p>To investigate the relationship between <code>GCSE</code> and <code>LRT</code> .</p></li>
<li><p>How the relationship between <code>GCSE</code> and <code>LRT</code> varies between schools.</p></li>
<li><p>Also we can address questions like, which <code>schools</code> appear to be most effective, taking prior achievement into account.</p></li>
</ul>
<p>Let us have a look at the data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let us get the GCSE data loaded in R</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">"gcse.dta"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># let us have a look at the data.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  school student   gcse    lrt  girl schgend   avslrt schav vrband
   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl+lbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1      1       1   2.61   6.19     1 1 [mixed]   1.66     2      1
2      1       2   1.34   2.06     1 1 [mixed]   1.66     2      2
3      1       3 -17.2  -13.6      0 1 [mixed]   1.66     2      3
4      1       4   9.68   2.06     1 1 [mixed]   1.66     2      2
5      1       5   5.44   3.71     1 1 [mixed]   1.66     2      2
6      1       6  17.3   21.9      0 1 [mixed]   1.66     2      1</code></pre>
</div>
</div>
</section>
<section id="seperate-linear-regressions-for-each-school4.3" class="level2">
<h2 class="anchored" data-anchor-id="seperate-linear-regressions-for-each-school4.3">Seperate linear regressions for each school(4.3)</h2>
<p>Before developing a model for all 65 schools combined, we consider a separate model for each school. For school <span class="math inline">\(j\)</span>, an obvious model for the relationship between GCSE and LRT is a simple regression model,</p>
<p><span class="math inline">\(y_{ij} = \beta_{1j}+\beta_{2j}x_{ij}+ \epsilon_{ij}\)</span></p>
<p>Where; <span class="math inline">\(y_{ij}\)</span> : GCSE score for the ith student in the school j.</p>
<p><span class="math inline">\(x_{ij}\)</span> : Corresponding LRT score.</p>
<p><span class="math inline">\(\beta_{1j}\)</span> : The school specific intercept.</p>
<p><span class="math inline">\(\beta_{2j}\)</span> : The school specific slope.</p>
<p><span class="math inline">\(\epsilon_{ij}\)</span> : Residual error term with school-specific variance <span class="math inline">\(\theta_j\)</span></p>
<p>For school 1, OLS estimates of the intercept <span class="math inline">\(\widehat{\beta}_{11}\)</span> and the slope <span class="math inline">\(\widehat{\beta}_{21}\)</span> can be obtained by using <code>lm()</code> function in R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regression model considering `gcse` as dependent variable and `lrt` as independent variable for school 1.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We can estimate the model directly. </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>model_1<span class="ot">&lt;-</span><span class="fu">lm</span>( gcse <span class="sc">~</span> lrt, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> <span class="fu">subset</span>(df, school <span class="sc">==</span> <span class="dv">1</span>) <span class="co"># Here, we are sub-setting the data for only school 1. </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>             )</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimates from model 1. </span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = gcse ~ lrt, data = subset(df, school == 1))

Residuals:
    Min      1Q  Median      3Q     Max 
-22.488  -5.443  -1.018   6.193  15.469 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  3.83330    0.98224   3.903 0.000214 ***
lrt          0.70934    0.09201   7.710 5.77e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 8.29 on 71 degrees of freedom
Multiple R-squared:  0.4557,    Adjusted R-squared:  0.448 
F-statistic: 59.44 on 1 and 71 DF,  p-value: 5.771e-11</code></pre>
</div>
</div>
<p>In the previous code, we took the subset within the <code>lm()</code> function. We can also first subset the data for school 1, and then use the <code>lm()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can also take a subset from the gcse data for school 1. </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df_1<span class="ot">&lt;-</span> <span class="fu">subset</span>(df, school <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The estimate the model from the subset data. The results will be the same</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>model_2 <span class="ot">&lt;-</span> <span class="fu">lm</span>( gcse <span class="sc">~</span> lrt, <span class="at">data =</span> df_1)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimates from model 2. </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = gcse ~ lrt, data = df_1)

Residuals:
    Min      1Q  Median      3Q     Max 
-22.488  -5.443  -1.018   6.193  15.469 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  3.83330    0.98224   3.903 0.000214 ***
lrt          0.70934    0.09201   7.710 5.77e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 8.29 on 71 degrees of freedom
Multiple R-squared:  0.4557,    Adjusted R-squared:  0.448 
F-statistic: 59.44 on 1 and 71 DF,  p-value: 5.771e-11</code></pre>
</div>
</div>
<p>To assess whether this is a reasonable model for school 1, we can obtain the predicted (OLS) regression line for this school (with <span class="math inline">\(j\)</span> = 1). The predicted schores are already estimated by the <code>lm()</code> function, and we need to access the predicted value.</p>
<p>Let us access and store the predicted values from model_2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitted.values calculated by the `lm()` function are the predicted values for the dependendent variables. </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># let us store the predicted gcse scores for school 1 as pred_gcse variable in the subset data for school 1. </span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>df_1<span class="sc">$</span>pred_gcse <span class="ot">&lt;-</span> model_2<span class="sc">$</span>fitted.values</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let us draw a scatterplot for observed and predicted gcse values for school 1. </span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_1, <span class="fu">aes</span>(<span class="at">x =</span> lrt, <span class="at">y =</span> gcse)) <span class="sc">+</span> </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">data=</span>df_1, <span class="fu">aes</span>(<span class="at">x=</span>lrt, <span class="at">y =</span> pred_gcse) )<span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">" Figure 4.1 : Scatterplot of gcse versus lrt for school 1 with OLS regression line"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"LRT"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y=</span> <span class="st">"GCSE"</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_Random_Coefficeint_models_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also produce <em>trellis graph</em> containing such plots for all 65 schools. To draw <em>trellis graph</em> we may use the <code>lattice</code> R-package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Trellis graph using lattice R-package. </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span> <span class="fu">xyplot</span>(gcse <span class="sc">~</span> lrt<span class="sc">|</span> school,df,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">panel =</span> <span class="cf">function</span>(x,y){</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">panel.xyplot</span>(x,y, <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>         <span class="fu">panel.lmline</span>(x,y, <span class="at">lty =</span> <span class="dv">4</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>       }, <span class="at">as.table =</span> T, </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Figure 4.2: Trellis of scatterplot with fitted regression lines for all 65 schools"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_Random_Coefficeint_models_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We will now fit a simple linear regression model for each school. First, we create a data set that contains only schools with 5 or more students. To do so, we create a data set <code>df_2</code>, and count number of students for each school using <code>count()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Counting number of students for each school, and sub-setting the data set for schools with 5 or more students. </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>df_2<span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(school) <span class="sc">%&gt;%</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count: number of student for each school</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">Count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(Count <span class="sc">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 10
  school student   gcse    lrt  girl schgend   avslrt schav vrband Count
   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl+lbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;
1      1       1   2.61   6.19     1 1 [mixed]   1.66     2      1    73
2      1       2   1.34   2.06     1 1 [mixed]   1.66     2      2    73
3      1       3 -17.2  -13.6      0 1 [mixed]   1.66     2      3    73
4      1       4   9.68   2.06     1 1 [mixed]   1.66     2      2    73
5      1       5   5.44   3.71     1 1 [mixed]   1.66     2      2    73
6      1       6  17.3   21.9      0 1 [mixed]   1.66     2      1    73</code></pre>
</div>
</div>
<p>Let us apply OLS regression for each school in the df_2 data set, and save intercept and slope estimates in df_3 data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying regression for each school and saving results</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>df_3<span class="ot">&lt;-</span> df_2 <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>school) <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">reg =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(gcse<span class="sc">~</span>lrt,.))) <span class="sc">%&gt;%</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">intercept =</span> <span class="fu">map_dbl</span>(reg, <span class="sc">~</span><span class="fu">coefficients</span>(.)[<span class="dv">1</span>]),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">slope =</span> <span class="fu">map_dbl</span>(reg, <span class="sc">~</span><span class="fu">coefficients</span>(.)[<span class="dv">2</span>]))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing additional variables</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>df_3<span class="ot">&lt;-</span> df_3[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  school intercept slope
   &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;
1      1    3.83   0.709
2      2    4.82   0.761
3      3    5.58   0.579
4      4    0.0375 0.761
5      5    2.60   0.680
6      6    6.03   0.535</code></pre>
</div>
</div>
<p>Let us explore the intercept and the slops for each school.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot of the OLS estimates of the intercept and slope for each school.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_3, <span class="fu">aes</span>(<span class="at">x=</span> intercept, <span class="at">y =</span> slope))<span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title=</span> <span class="st">"Figure 4.3: Scatterplot of estimated intercepts and slopes for all schools </span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="st">          (with at least five students)"</span>, </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span><span class="st">"Intercept"</span>, </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y=</span> <span class="st">"slope"</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_Random_Coefficeint_models_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We see that there is considerable variability between the estimated intercept and slopes of different schools. To investigate this further we obtain summary statistics for intercept and slopes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics of intercepts and slopes.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating summaries for intercepts</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>df_4<span class="ot">&lt;-</span> df_3 <span class="sc">%&gt;%</span> </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Obs=</span><span class="fu">n</span>(), </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">Mean =</span> <span class="fu">mean</span>(intercept, <span class="at">na.rm=</span>T), </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">Std.dev. =</span> <span class="fu">sd</span>(intercept, <span class="at">na.rm=</span>T), </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">Min =</span> <span class="fu">min</span>(intercept), </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">Max =</span> <span class="fu">max</span>(intercept)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating summaries for slope</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>df_5<span class="ot">&lt;-</span> df_3 <span class="sc">%&gt;%</span> </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Obs=</span><span class="fu">n</span>(), </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">Mean =</span> <span class="fu">mean</span>(slope, <span class="at">na.rm=</span>T), </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">Std.dev. =</span> <span class="fu">sd</span>(slope, <span class="at">na.rm=</span>T), </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">Min =</span> <span class="fu">min</span>(slope), </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">Max =</span> <span class="fu">max</span>(slope)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Combining summary statistics</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>sum<span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(df_4,df_5))</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(sum) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"intercept"</span>, <span class="st">"slope"</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>sum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Obs       Mean  Std.dev.         Min      Max
intercept  64 -0.1805974 3.2913568 -8.51925311 6.838715
slope      64  0.5390514 0.1766135  0.03809654 1.076979</code></pre>
</div>
</div>
<p>To allow comparison with the parameter estimates obtained from the random-coefficient model considered later on, we also obtain the covaraince matrix of the estimated intercepts and slopes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can easily calculate variance covariance matrix by `cov()` function. </span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>var_cov<span class="ot">&lt;-</span> <span class="fu">cov</span>(df_3[,<span class="sc">-</span><span class="dv">1</span>]) <span class="co"># we are ignoring the school variable in the first column</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(var_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">intercept</th>
<th style="text-align: right;">slope</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">intercept</td>
<td style="text-align: right;">10.8330293</td>
<td style="text-align: right;">0.2086222</td>
</tr>
<tr class="even">
<td style="text-align: left;">slope</td>
<td style="text-align: right;">0.2086222</td>
<td style="text-align: right;">0.0311923</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can also obtain <em>spaghetti plot</em> of the predicted school-specific regression lines for all school. To do so, let us merge the intercept-slope data with the original data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merging intercept and slop values in original data set by school. </span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We can easily use `merge()` function to do so. </span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>df_6<span class="ot">&lt;-</span> <span class="fu">merge</span>(df, df_3, <span class="at">by =</span> <span class="st">"school"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  school student     gcse      lrt girl schgend avslrt schav vrband intercept
1      1       1   2.6132   6.1906    1       1 1.6617     2      1  3.833302
2      1       2   1.3407   2.0580    1       1 1.6617     2      2  3.833302
3      1       5   5.4434   3.7110    1       1 1.6617     2      2  3.833302
4      1       6  17.3490  21.8940    0       1 1.6617     2      1  3.833302
5      1       3 -17.2390 -13.6460    0       1 1.6617     2      3  3.833302
6      1       4   9.6759   2.0580    1       1 1.6617     2      2  3.833302
      slope
1 0.7093406
2 0.7093406
3 0.7093406
4 0.7093406
5 0.7093406
6 0.7093406</code></pre>
</div>
</div>
<p>let us calculate the predicted gcse scores for each school.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating predicted gcse scores for each school</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df_7<span class="ot">&lt;-</span> df_6 <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> intercept <span class="sc">+</span> slope<span class="sc">*</span>lrt)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  school student     gcse      lrt girl schgend avslrt schav vrband intercept
1      1       1   2.6132   6.1906    1       1 1.6617     2      1  3.833302
2      1       2   1.3407   2.0580    1       1 1.6617     2      2  3.833302
3      1       5   5.4434   3.7110    1       1 1.6617     2      2  3.833302
4      1       6  17.3490  21.8940    0       1 1.6617     2      1  3.833302
5      1       3 -17.2390 -13.6460    0       1 1.6617     2      3  3.833302
6      1       4   9.6759   2.0580    1       1 1.6617     2      2  3.833302
      slope      pred
1 0.7093406  8.224545
2 0.7093406  5.293125
3 0.7093406  6.465665
4 0.7093406 19.363603
5 0.7093406 -5.846359
6 0.7093406  5.293125</code></pre>
</div>
</div>
<p>We can use <code>ggplot()</code> function to create the spaghetti plot of OLS regression lines for all schools.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>df_7, <span class="fu">aes</span>(<span class="at">x=</span> lrt, <span class="at">y =</span> pred, <span class="at">group =</span> school)) <span class="sc">+</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Figure 4.4: Spaghetti plot of ordinary least-square regression line</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="st">           for schools with at least five students"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span><span class="st">"LRT"</span>, </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y=</span> <span class="st">"Fitted regression line"</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="04_Random_Coefficeint_models_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="model-estimation-4.5" class="level1">
<h1>Model Estimation (4.5)</h1>
<section id="estimation-of-random-intercept-model4.5.1" class="level2">
<h2 class="anchored" data-anchor-id="estimation-of-random-intercept-model4.5.1">Estimation of Random-intercept model(4.5.1)</h2>
<p>We first consider a random-intercept model.</p>
<p><span class="math inline">\(y_{ij} = (\beta_1 +\zeta_{1j}) + \beta_2x_{ij}+\epsilon_{ij}\)</span></p>
<p>The model is a special case of the random-coefficient model with <span class="math inline">\(\zeta_{2j}=0\)</span> or, equivalently, with zero random-slope variance and zero random-intercept and random-slope covaraince, <span class="math inline">\(\psi_{22}= \psi_{21} =0\)</span></p>
<p>ML estimates for the random-intercept model can be obtained using <code>lmer()</code> R-function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let us estimate the random intercept model</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The model is stored in mod3. </span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>model_3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(gcse <span class="sc">~</span> lrt <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>school), </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">data=</span> df, </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">REML=</span><span class="cn">FALSE</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by maximum likelihood . t-tests use Satterthwaite's
  method [lmerModLmerTest]
Formula: gcse ~ lrt + (1 | school)
   Data: df

     AIC      BIC   logLik deviance df.resid 
 28057.6  28082.8 -14024.8  28049.6     4055 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.7162 -0.6304  0.0287  0.6844  3.2680 

Random effects:
 Groups   Name        Variance Std.Dev.
 school   (Intercept)  9.213   3.035   
 Residual             56.573   7.521   
Number of obs: 4059, groups:  school, 65

Fixed effects:
             Estimate Std. Error        df t value Pr(&gt;|t|)    
(Intercept) 2.387e-02  4.002e-01 6.166e+01    0.06    0.953    
lrt         5.634e-01  1.247e-02 4.052e+03   45.20   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
    (Intr)
lrt 0.008 </code></pre>
</div>
</div>
</section>
<section id="estimation-of-random-coefficient-model-4.5.2" class="level2">
<h2 class="anchored" data-anchor-id="estimation-of-random-coefficient-model-4.5.2">Estimation of Random-coefficient model (4.5.2)</h2>
<p>We now relax the assumption that the school-specific regression lines are parallel by introducing random school-specific slopes <span class="math inline">\(\beta_2 + \zeta_{2j}\)</span> of <code>lrt</code>:</p>
<p><span class="math inline">\(y_{ij} = (\beta_1 +\zeta_{1j}) + (\beta_2+\zeta_{2j})x_{ij}+\epsilon_{ij}\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Random coefficient model </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>model_4<span class="ot">&lt;-</span> <span class="fu">lmer</span>(gcse<span class="sc">~</span> lrt<span class="sc">+</span>(lrt<span class="sc">|</span>school), </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span>df, </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">REML=</span> <span class="cn">FALSE</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by maximum likelihood . t-tests use Satterthwaite's
  method [lmerModLmerTest]
Formula: gcse ~ lrt + (lrt | school)
   Data: df

     AIC      BIC   logLik deviance df.resid 
 28021.2  28059.1 -14004.6  28009.2     4053 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.8312 -0.6325  0.0340  0.6832  3.4561 

Random effects:
 Groups   Name        Variance Std.Dev. Corr
 school   (Intercept)  9.04467 3.0074       
          lrt          0.01453 0.1206   0.50
 Residual             55.36543 7.4408       
Number of obs: 4059, groups:  school, 65

Fixed effects:
            Estimate Std. Error       df t value Pr(&gt;|t|)    
(Intercept) -0.11508    0.39783 61.57724  -0.289    0.773    
lrt          0.55673    0.01994 57.14187  27.926   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
    (Intr)
lrt 0.365 </code></pre>
</div>
</div>
</section>
<section id="testing-the-slope-variance-4.6" class="level2">
<h2 class="anchored" data-anchor-id="testing-the-slope-variance-4.6">Testing the slope variance (4.6)</h2>
<p>Before interpreting the parameter estimates, we may want to test whether the random slope is needed in addition to the random intercept. Specifically, we test the null hypothesis:</p>
<p><span class="math inline">\(H_0: \psi_{22}=0\\ vs\\ H_a:\psi_{22}&gt;0\)</span></p>
<p>Note that<span class="math inline">\(H_0\)</span> is equivalent to the hypothesis that the random slopes <span class="math inline">\(\zeta_{2j}\)</span> are all 0. The null hypothesis also implies that <span class="math inline">\(\psi_{21}=0\)</span> , because a variable that does not vary also does not covary with other variables. Setting <span class="math inline">\(\psi_{22}=0\)</span> and <span class="math inline">\(\psi_{21}=0\)</span> gives the random-intercept model.</p>
<p>Hence, a native Likelihood-ratio test can be performed comparing mod3 and mod4.</p>
<p>For the purpose, we may use <code>anova()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Likelihood-Ratio test </span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>lr_test<span class="ot">&lt;-</span><span class="fu">anova</span>(model_3,model_4)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>lr_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: df
Models:
model_3: gcse ~ lrt + (1 | school)
model_4: gcse ~ lrt + (lrt | school)
        npar   AIC   BIC logLik deviance  Chisq Df Pr(&gt;Chisq)    
model_3    4 28058 28083 -14025    28050                         
model_4    6 28021 28059 -14005    28009 40.372  2  1.711e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
</section>
<section id="assignining-values-to-the-random-intercepts-and-slopes4.8" class="level1">
<h1>Assignining values to the random intercepts and slopes(4.8)</h1>
<section id="maximum-likelihood-estimation4.8.1" class="level2">
<h2 class="anchored" data-anchor-id="maximum-likelihood-estimation4.8.1">Maximum “likelihood” estimation(4.8.1)</h2>
<p>Maximum “likelihood” estimates of the random intercepts and slopes can be obtained by first predicting the total residuals <span class="math inline">\(\widehat{\epsilon}_{ij}= y_{ij}-(\widehat{\beta}_1+\widehat{\beta_2}x_{ij})\)</span> and then fitting individual regressions of <span class="math inline">\(\widehat{\epsilon}_{ij}\)</span> on <span class="math inline">\(x_{ij}\)</span> for each school by OLS.</p>
<p>(the rest of this chapter is still under development)</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>